from pyspark.sql.functions import col, current_timestamp, year

# --- CONFIGURATION ---
storage_account_name = "stresumeprojectdd"
container_name = "nyctaxi"
# âš ï¸ PASTE YOUR KEY BELOW
access_key = "PASTE_YOUR_ACCESS_KEY_HERE"

# 1. Authenticate
spark.conf.set(
    f"fs.azure.account.key.{storage_account_name}.blob.core.windows.net",
    access_key
)

# 2. READ: Load the Raw (Bronze) Data
file_path = f"wasbs://{container_name}@{storage_account_name}.blob.core.windows.net/raw/yellow_tripdata_2024-01.parquet"
print(f"ðŸ“– Reading raw data from: {file_path}")

df_raw = spark.read.parquet(file_path)
print(f"âœ… Loaded {df_raw.count()} rows.")

# 3. TRANSFORM: Clean and Rename
print("ðŸ§¹ Cleaning data (V3: Strict Physics Checks)...")

df_silver = (df_raw
    .withColumnRenamed("tpep_pickup_datetime", "pickup_time")
    .withColumnRenamed("tpep_dropoff_datetime", "dropoff_time")
    .withColumnRenamed("passenger_count", "passengers")
    .withColumnRenamed("total_amount", "total_cost")
    
    # Filter 1: Basic Validity (No negative money, no empty cabs)
    .filter(col("total_cost") > 0)
    .filter(col("passengers") > 0)
    
    # Filter 2: Time Travel Fix (The Year 2024) ðŸ•’
    .filter(year(col("pickup_time")) == 2024)
    
    # Filter 3: Physics Check (No stationary trips, no GPS errors) ðŸ”¬
    .filter(col("trip_distance") > 0)
    .filter(col("trip_distance") < 500)
    
    # Add Auditing Column
    .withColumn("ingestion_date", current_timestamp())
)

print(f"âœ… Cleaned data has {df_silver.count()} rows.")

# 4. WRITE: Overwrite the Silver Table
save_path = f"wasbs://{container_name}@{storage_account_name}.blob.core.windows.net/silver/taxi_trips"
print(f"ðŸ’¾ Saving to Delta Lake at: {save_path}...")

(df_silver.write
    .format("delta")
    .mode("overwrite")
    .save(save_path)
)

print("âœ… Success! Silver Layer updated.")

# 5. DATA QUALITY CHECK (Profiling)
# This verification step ensures our logic successfully removed outliers.
print("\nðŸ•µï¸â€â™‚ï¸ Profiling Final Data Stats...")

display(df_silver.select(
    "passengers",
    "total_cost",
    "trip_distance"
).summary("min", "mean", "max"))
